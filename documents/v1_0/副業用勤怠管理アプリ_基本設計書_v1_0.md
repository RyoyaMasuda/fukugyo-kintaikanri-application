# 副業用勤怠管理アプリ 基本設計書 (Ver 1.0)

## 1. システム構成 (Architecture)

### 1.1 技術スタック

* **Frontend:** Next.js (TypeScript) / AWS Amplify Gen 2 (Hosting)

* **Backend:** Python (FastAPI) / AWS Lambda

* **API Gateway:** Amazon API Gateway

* **Database:** Amazon DynamoDB

* **Auth:** Amazon Cognito (User Pool)

### 1.2 データフロー概要

1. **ユーザー**がNext.js画面で操作を行う。

2. **Amplify/Cognito**がユーザー認証を行い、アクセストークン（JWT）を発行する。

3. **Next.js**がAPI Gatewayへリクエストを送る（ヘッダーにトークンを添付）。

4. **API Gateway**がリクエストを受け取り、**Lambda (FastAPI)** を起動する。

5. **FastAPI**がロジックを処理し、**DynamoDB**へデータの読み書きを行う。

---

## 2. データベース設計 (DynamoDB)

DynamoDBはNoSQLデータベースのため、データの取得パターンに合わせてキーを設計します。

今回は「ユーザーごと」に「時系列」でデータを並べるシンプルな設計にします。

* **テーブル名:** `AttendanceTable`

| 項目名 (Key Type) | 属性名 | データ型 | 格納する値の例 | 説明 |
| :--- | :--- | :--- | :--- | :--- |
| **Partition Key (PK)** | `userId` | String | `sub-1234-abcd` | CognitoのユーザーID (sub)。これでユーザーを特定する。 |
| **Sort Key (SK)** | `timestamp` | String | `2025-12-14T09:00:00` | 打刻日時 (ISO 8601形式)。これで時系列順に並ぶ。 |
| Attribute | `type` | String | `start` または `end` | 出勤か退勤かの種類。 |
| Attribute | `note` | String | `A社案件` | (将来用) 備考やメモ。 |

> **設計のポイント:**
> 
> PKで「誰のデータか」を絞り込み、SKで「いつのデータか」を範囲検索（Query）できるようにしています。
> 
> これにより、「今月のデータを全部ちょうだい」というリクエストが高速に処理できます。

---

## 3. API設計 (FastAPI / Endpoints)

フロントエンドとバックエンドが通信するための約束事です。

全てのAPIリクエストには、AuthorizationヘッダーにCognitoのトークンが必要です。

### 3.1 勤怠打刻 (POST)

* **URL:** `/attendance`

* **Method:** `POST`

* **概要:** 出勤または退勤を記録する。

* **リクエストボディ (JSON):**

  ```json
  {
    "type": "start"  // または "end"
  }
  ```

* **処理内容:**
  * トークンからuserIdを取得。
  * 現在時刻を生成。
  * DynamoDBに userId, timestamp, type を保存。

### 3.2 勤怠履歴取得 (GET)

* **URL:** `/attendance`

* **Method:** `GET`

* **概要:** 指定した期間の勤怠履歴を取得する。

* **クエリパラメータ:**
  * `start_date`: 取得開始日 (例: 2025-12-01)
  * `end_date`: 取得終了日 (例: 2025-12-31)

* **レスポンス (JSON):**

  ```json
  [
    {
      "userId": "sub-1234-abcd",
      "timestamp": "2025-12-14T09:00:00",
      "type": "start"
    },
    {
      "userId": "sub-1234-abcd",
      "timestamp": "2025-12-14T18:00:00",
      "type": "end"
    }
  ]
  ```

---

## 4. 画面設計 (Frontend / Next.js)

### 4.1 ページ構成

| パス | 画面名 | 必要なコンポーネント・機能 |
| :--- | :--- | :--- |
| `/login` | ログイン画面 | Amplify UI Authenticator (ログイン・新規登録) |
| `/` | ホーム (ダッシュボード) | ・現在の状態表示 (勤務中 / 勤務外)<br>・「出勤」ボタン (勤務外のとき表示)<br>・「退勤」ボタン (勤務中のとき表示)<br>・今月の稼働時間合計 |
| `/history` | 履歴一覧画面 | ・月選択カレンダー<br>・勤怠データのテーブル表示 |

### 4.2 共通機能

* **認証ガード:** ログインしていない状態でホームなどにアクセスしたら、自動的にログイン画面へ飛ばす。
* **APIクライアント:** API Gatewayへの通信を行う共通関数を作成する（AxiosやFetch APIを使用）。

